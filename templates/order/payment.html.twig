{% extends 'base.html.twig' %}

{% block body %}
<div class="container mt-5">
        <h1 class="mb-5 text-center">Aperçu et paiement de votre commande</h1>
    <div class="row justify-content-between">
        <div class="col-md-6">
            <div>
                <h3>Votre commande</h3>
                <hr>
                {% for item in items %}
                    <p>{{ item.stockProduct.product.name }}</p>
                    <div class="d-flex justify-content-between">
                        <p>Quantité : <strong>{{ item.quantity }}</strong></p>
                        <p><strong>{{ item.stockProduct.product.price * item.quantity }} €</strong></p>
                    </div>
                    <hr>
                {% endfor%}
            </div>
            <div class="d-flex my-5 justify-content-between">
                {% if is_granted('ROLE_SUBSCRIBER') %}
                <div>
                    <h5 class="mb-3 font-weight-bold">Adresse de livraison :</h5>
                    <p>{{ shippingAddress.firstname }} {{ shippingAddress.lastname }}</p>
                    <p>{{ shippingAddress.street }}</p>
                    <p>{{ shippingAddress.complement }}</p>
                    <p>{{ shippingAddress.zipCode }}</p>
                    <p>{{ shippingAddress.city }}</p>
                    <p>{{ shippingAddress.country }}</p>
                    <p>{{ shippingAddress.phone }}</p>
                    <a href="{{ path('shippingAddress_edit', {'id': shippingAddress.id}) }}">Modifier</a>
                </div>
                <div>
                    <h5 class="mb-3 font-weight-bold">Adresse de facturation :</h5>
                    <p>{{ billingAddress.firstname }} {{ billingAddress.lastname }}</p>
                    <p>{{ billingAddress.street }}</p>
                    <p>{{ billingAddress.complement }}</p>
                    <p>{{ billingAddress.zipCode }}</p>
                    <p>{{ billingAddress.city }}</p>
                    <p>{{ billingAddress.country }}</p>
                    <p>{{ billingAddress.phone }}</p>
                    <a href="{{ path('billingAddress_edit', {'id': billingAddress.id}) }}">Modifier</a>
                </div>
                {% else %}
                    <div>
                        <h5 class="mb-3 font-weight-bold">Adresse de livraison et de facturation :</h5>
                        <p>{{ infoClient.firstname }} {{ infoClient.lastname }}</p>
                        <p>{{ infoClient.street }}</p>
                        <p>{{ infoClient.complement }}</p>
                        <p>{{ infoClient.zipCode }}</p>
                        <p>{{ infoClient.city }}</p>
                        <p>{{ infoClient.country }}</p>
                        <p>{{ infoClient.phone }}</p>
                        <a href="{{ path('app_login') }}">Différencier les adresses ?</a>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-5">
            <div class="card card-shadow bg-white card-detail">
                <div class="card-body">
                    <h3>Paiement</h3>
                    <hr>
                    <p>Total des articles : <strong>{{ totalArticle }} €</strong></p>
                    <hr>
                    <h5>Livraison</h5>
                    <p>{{ shipping.type }} : <strong>{{ shipping.price }} €</strong></p>
                    <hr>
                    <h5 class="font-weight-bold">Total</h5>
                    <p class="text-right">Total : <strong>{{ total }} €</strong></p>
                    <div class="card card-shadow my-4">
                        <div class="card-body">
                            <h5 class="text-center font-weight-bold">Informations de carte bancaire</h5>
                            <form method="post">
                                <div class="form-group text-danger" id="errors"></div>
                                <div class="form-group">
                                    <label for="cardholder-name">Nom du titulaire*</label>
                                    <input class="form-control" type="text" id="cardholder-name" placeholder="Titulaire de la carte" required>
                                </div>
                                <div class="form-group credit-card" id="card-elements">
                                    <!-- Elements will create input elements here -->
                                </div>
                                    <!-- We'll put the error messages in this element -->
                                <div class="form-group text-danger" id="card-errors" role="alert"></div>
                                <button class="btn btn-dark w-100 mt-3" id="card-button" type="submit" data-secret="{{ intent['client_secret'] }}">Payer</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        window.onload = () => {
            //Var
            let stripe = Stripe('pk_test_51HG5BSDtJEs1xZocKB9iRFNyyjuJAwOJ4IeZuHA5Ef94t1bwmMrvFDgS6oB29hvGenIFvy3FDCayib8FYsDdl9a200Qu20BGFr')
            let elements = stripe.elements()
            //Object
            let cardHolderName = document.getElementById('cardholder-name')
            let cardButton = document.getElementById('card-button')
            let clientSecret = cardButton.dataset.secret
            //form elements
            let card = elements.create("card")
            card.mount("#card-elements")
            // The capture
            card.addEventListener("change", (event) => {
                let displayError = document.getElementById("card-errors")
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = "";
                }
            })
            //Payment
            cardButton.addEventListener("click", () => {
                stripe.handleCardPayment(
                    clientSecret, card, {
                        payment_method_data: {
                            billing_details: {name: cardHolderName.value}
                        }
                    }
                ).then((result) => {
                    if (result.error) {
                        document.getElementById("errors").innerText = result.error.message
                    }
                })
            })
        }
    </script>
{% endblock %}